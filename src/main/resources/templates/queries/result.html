<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="'Результат запроса: ' + ${queryName}">Результат</title>
    <style>
        table {
            width: 90%;
            margin: 40px auto;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        h2 {
            text-align: center;
            margin-top: 40px;
            color: #37474f;
        }

        /* Стиль для кнопки экспорта */
        .export-btn-container {
            text-align: center;
            margin-top: 20px;
        }

        .export-btn-container button {
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .export-btn-container button:hover {
            background-color: #45a049;
        }

        .export-btn-container button:focus {
            outline: none;
        }
    </style>
</head>
<body>
<h2 th:text="'Результат запроса: ' + ${queryName}">Результат запроса</h2>

<table th:if="${result != null and !result.isEmpty()}">
    <thead>
    <tr>
        <th th:each="col : ${result[0].keySet()}" th:text="${col}"></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="row : ${result}">
        <td th:each="entry : ${row.entrySet()}" th:text="${entry.value}"></td>
    </tr>
    </tbody>
</table>

<p th:if="${result == null or result.isEmpty()}" style="text-align:center; color: grey;">
    Нет данных для отображения.
</p>
<!-- Кнопка экспорта в Excel -->
<div class="export-btn-container">
    <button type="button" class="run-btn" onclick="exportToExcel()">Экспорт в Excel</button>
</div>
<script>
    function exportToExcel() {
        // Считываем данные из таблицы
        const tableData = [];
        const headers = Array.from(document.querySelectorAll('th')).map(th => th.innerText);
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const rowData = {};
            const cells = row.querySelectorAll('td');
            cells.forEach((cell, index) => {
                rowData[headers[index]] = cell.innerText;
            });
            tableData.push(rowData);
        });

        // Отправляем данные на сервер в формате JSON
        const url = `/queries/export`;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({data: tableData})
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();  // Получаем Blob-объект для файла Excel
                }
                throw new Error('Ошибка при экспорте данных');
            })
            .then(blob => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'query_result.xlsx';  // Имя файла для скачивания
                link.click();  // Инициируем скачивание файла
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
</script>
</body>
</html>